From 8abcd1aac3f65585dfb2e761dd737c0609cd5f93 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Sun, 1 Jun 2014 23:46:09 +0200
Subject: server: Add additional checks in get_xattr_sd to prevent crashes
 caused by invalid attributes.

---
 server/file.c |   10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/server/file.c b/server/file.c
index 08231a7..11522c3 100644
--- a/server/file.c
+++ b/server/file.c
@@ -738,12 +738,18 @@ struct security_descriptor *get_xattr_sd( int fd )
     int n;
 
     n = fgetxattr( fd, "user.wine.sd", buffer, sizeof(buffer) );
-    if (n == -1) return NULL;
+    if (n == -1 || n < 2 + sizeof(struct security_descriptor)) return NULL;
+
     /* validate that we can handle the descriptor */
     if (buffer[0] != SECURITY_DESCRIPTOR_REVISION || buffer[1] != 0) return NULL;
 
+    sd = (struct security_descriptor *)&buffer[2];
+    if (n  < 2 + sizeof(struct security_descriptor) + sd->owner_len
+               + sd->group_len + sd->sacl_len + sd->dacl_len)
+        return NULL;
+
     sd = mem_alloc( n - 2 );
-    memcpy( sd, &buffer[2], n - 2 );
+    if (sd) memcpy( sd, &buffer[2], n - 2 );
     return sd;
 #else
     return NULL;
-- 
1.7.9.5

